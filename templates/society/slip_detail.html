{% extends 'society/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-6">

  <!-- Slip Card -->
  <div id="slip" class="card shadow-lg p-4 slip-to-print" 
       style="max-width: 800px; margin: 0 auto; border: 1.0px solid #555; border-radius: 12px; background: #fff;">

    <!-- Header -->
    <div class="text-center mb-3">
      <h3 class="fw-bold mb-2 " style="font-size: 30px;">üè¢ Popular Vista</h3>
      <br>

      <p class="mb-1" style="font-size:20px;">Slip No: <strong>{{ slip.slip_no }}</strong> &nbsp;|&nbsp; Date: {{ slip.date }}</p>
      

      <p class="text-muted" style="font-size:20px;">
        Address: Popular Vista, Gota, Ahmedabad, Gujarat, 359751 | Contact: 9513578520
      </p>
    </div>

    <hr style="border-top: 1px solid #888;">

    <!-- Resident & Block Info -->
    <div class="row mt-3 mb-2" style="font-size:15px;">
      <div class="col-md-6">
        <p class="mb-1"><strong>Block:</strong> {{ slip.block.name }}</p>
        <p class="mb-1"><strong>Flat No:</strong> {{ slip.resident.flat_no }}</p>
      </div>
      <div class="col-md-6 text-end">
        <p class="mb-1"><strong>Name:</strong> {{ slip.resident.name }}</p>
        <p class="mb-1"><strong>Maintenance Date:</strong> {{ slip.maintenance_charge_date }}</p>
      </div>
    </div>

    <hr style="border-top: 1px solid #888;">

    <!-- Payment Info -->
    <div class="mt-3" style="font-size:13px;">
      <p class="mb-1"><strong>Amount (in words):</strong> {{ slip.amount_text }}</p>
      <p class="mb-1">
        <strong>Payment Mode:</strong> {{ slip.get_payment_method_display }}
        {% if slip.cheque_details %} - {{ slip.cheque_details }}{% endif %}
      </p>
    </div>

    <hr style="border-top: 1px solid #888;">

    <!-- Amount & Signature -->
    <div class="d-flex justify-content-between align-items-center mt-4">
      <div style="font-size:18px; font-weight:bold;">
        ‚Çπ <span class="border px-3 py-2" style="border-radius:6px;">{{ slip.amount_number }}</span>
      </div>
      <div class="text-center">
        <img src="{% static 'images/download.png' %}" alt="signature" width="130" class="mb-1">
        <p class="mb-0" style="font-size:13px;">Chairman</p>
      </div>
    </div>

    <hr style="border-top: 1px dashed #aaa; margin-top: 30px;">
    <p class="text-center text-muted" style="font-size:11px; margin-bottom:0;">Thank you for your cooperation!</p>
  </div>

  <!-- Buttons (Outside Slip) -->
  <div class="text-center mt-4">
    <button class="btn btn-primary me-2" onclick="printSlip()">
      <i class="fas fa-print me-2"></i>Print / Save as PDF
    </button>

    <button class="btn btn-success me-2" onclick="downloadSlipPDF()">
      <i class="fas fa-download me-2"></i>Download PDF
    </button>

    <a href="{% url 'create_slip_block' slip.block.id %}" class="btn btn-secondary">
      <i class="fas fa-plus me-2"></i>Create Another
    </a>
  </div>

</div>
{% endblock %}

{% block scripts %}
<!-- jsPDF + html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
function printSlip() {
  const slipContent = document.querySelector('#slip').innerHTML;
  const originalContent = document.body.innerHTML;
  document.body.innerHTML = slipContent;
  window.print();
  document.body.innerHTML = originalContent;
  location.reload();
}

async function downloadSlipPDF() {
  const { jsPDF } = window.jspdf;
  const slipElement = document.getElementById('slip');
  
  const canvas = await html2canvas(slipElement, { scale: 2 });
  const imgData = canvas.toDataURL('image/png');

  const pdf = new jsPDF('p', 'mm', 'a4');
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

  // Center slip vertically on A4
  const yOffset = (pdf.internal.pageSize.getHeight() - pdfHeight) / 2;

  pdf.addImage(imgData, 'PNG', 0, yOffset, pdfWidth, pdfHeight);
  pdf.save("Maintenance_Slip_{{ slip.slip_no }}.pdf");
}
</script>
{% endblock %}
